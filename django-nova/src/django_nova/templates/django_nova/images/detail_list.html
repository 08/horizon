{% extends "django_nova/images/base.html" %}

{% block title %} - Launch an Image{% endblock %}

{% block headerjs %}
<script type="text/javascript" src="/media/django_nova/js/jquery.form.js"></script>
{% endblock %}


{% block content %}
  <div id="right_content">
    <div id="page_head">
      <h2 id="page_heading">Images</h2>
      <p id="page_description">Images are snapshots of running systems which can easily be deployed to run one or more instances.</p>
    </div>

    {% include "django_nova/_messages.html" %}

    {% if images %}
    <table id="image_launch">
      <tr>
        <th>ID</th>
        <th>Description</th>
        <th colspan="2">Owner</th>
      </tr>
      {% for image in images %}
      <tr class="{% cycle 'odd' 'even' %}">
        {% if image.id == ami.id %}
          <td class="detail_wrapper" colspan="4">
            <div id="{{ ami.id }}" class="image_detail">
              <div class="column">
                <div class="image_detail_item">
                  <span class="label">Owner: </span>
                  <span class="data">{{ ami.ownerId }}</span>
                </div>

                <div class="image_detail_item">
                  <span class="label">Description: </span>
                  <span class="data">{{ ami.description }}</span>
                </div>

                <div class="image_detail_item">
                  <span class="label">Location: </span>
                  <span class="data">{{ ami.location }}</span>
                </div>
              </div>

              <div class="column">
                <div class="image_detail_item">
                  <span class="label">ID: </span>
                  <span class="data">{{ ami.id }}</span>
                </div>
                <div class="image_detail_item">
                  <span class="label">Name: </span>
                  <span class="data">{% if ami.displayName %}{{ ami.displayName }}{%else%}{{ ami.id }}{% endif %}</span>
                </div>
                <div class="image_detail_item">
                  <span class="label">Type: </span>
                  <span class="data">{{ ami.type }}</span>
                </div>
                <div class="image_detail_item">
                  <span class="label">Architecture: </span>
                  <span class="data">{{ ami.architecture }}</span>
                </div>
              </div>

              <div id="last" class="column">
                {% if ami.is_public %}
                  <div id="public" class="privacy">Public Image</div>
                {% else %}
                  <div id="private" class="privacy">Private Image</div>
                {% endif %}

                <a id="launch_{{ image.id }}" class="launch" href="{% url nova_images_launch project.projectname image.id %}" title="Click to launch image">Launch</a>
                {% if can_modify or user.username == ami.ownerId %}
                  <a id="edit_image_link" href="{% url nova_images_update project.projectname ami.id %}">Edit Image</a>
                {% endif %}

              </div>

              {% if can_modify or user.username == ami.ownerId %}
                <span class="image_privacy">
                  <form id="privacy_{{ ami.id }}" action="{% url nova_images_privacy project.projectname ami.id %}" method="post" accept-charset="utf-8">
                    {% csrf_token %}
                    {% if ami.is_public %}
                      <input class="private" type="submit" value="Make Private" />
                    {% else %}
                      <input class="public" type="submit" value="Make Public" />
                    {% endif %}
                  </form>
                </span>

                <span class="delete">
                  <form id="delete_{{ ami.id }}" action="{% url nova_images_remove project.projectname ami.id %}" method="post" accept-charset="utf-8">
                    {% csrf_token %}
                    <input type="submit" value="Remove Image" />
                  </form>
                </span>
              {% endif %}
            </div>
          </td>
        {% else %}
          <td class="image_id"><a href="{% url nova_images_detail project.projectname image.id %}">{{ image.id }}</a></td>
          <td class="image_location odd">
          {% if image.description %}
            {{ image.description }}
          {% else %}
            {{ image.location }}
          {% endif %}
          </td>
          <td class="image_owner_id">{{ image.ownerId }}</td>
          <td class="image_launch_btn odd"><a id="launch_{{ image.id }}" class="launch" href="{% url nova_images_launch project.projectname image.id %}">Launch</a></td>
          {#<td class="odd"><a class="ui-state-default ui-corner-all" onclick="$('#dlg_launch').dialog('open');">Launch</a></td>#}
        {% endif %}
      </tr>
      {% endfor %}
    </table>
    {% else %}
    <div class="ui-widget">
      <div class="ui-state-highlight ui-corner-all">
        <p>
          <span class="ui-icon ui-icon-info"></span>
          No images currently available.
        </p>
      </div>
    </div>
    {% endif %}
  </div>

  <div id="dlg_launch" title="Launch Instance" style="display:none;">
    <form id="frm_launch" action="url nova_images_launch project.projectname" method="post">
      {% csrf_token %}
      {% include "django_nova/images/_launch_form.html" %}
    </form>
  </div>

  <div id="dlg_confirm" title="Confirm Termination">
    <p>Are you sure you wish to unregister the <span id="ami_name"></span> image?</p>
  </div>

{% endblock %}

{% block footerjs %}
{{ block.super }}
<script type="text/javascript">
  var options = {
    success:      handleResponse,
    beforeSubmit: showRequest,
    dataType:     'json'
  }

  // TODO: On dialog open, reset form and validation.
  $(function() {
    $('#dlg_launch').dialog({
      buttons: {
        'Ok': function() {
          $('#frm_launch').ajaxSubmit(options);
        },
        'Cancel': function() {
          $(this).dialog('close');
        }
      },
      autoOpen: false,
      resizable: false,
      width: 400,
      height: 400
    });
  });

	function showRequest(formData, jqForm, options) {
    var queryString = $.param(formData);
    alert('About to submit: \n\n' + queryString);
    return true;
	}

	function handleResponse(data, statusText, xhr, $form) {
	  alert('status: ' + statusText + '\nsuccess:\n\n' + data.success);
	}

	$(function(){
	  $('.delete form').submit(function() {
      ami_name = $(this).parent().parent().attr("id");
      $('#ami_name').text(ami_name);
      $('#dlg_confirm').dialog('open');
      return false;
    });

    $('#dlg_confirm').dialog({
      buttons: {
       'Ok': onConfirmOK,
       'Cancel': function() { $(this).dialog('close'); }
      },
        autoOpen: false,
        resizable: false,
        width: 500,
        height: 200
    });
  })

  function onConfirmOK() {
    $(this).dialog('close');
    form = document.getElementById('delete_' + ami_name);
    if(form) form.submit();
  }

</script>
{% endblock %}
